<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="icon" href="/static/logo.png?v=2" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --ink: #1f2933;
            --ink-muted: #52606d;
            --accent: #2563eb;
            --accent-strong: #1d4ed8;
            --accent-soft: #e0e7ff;
            --accent-warm: #f97316;
            --surface: #ffffff;
            --surface-soft: #f8fafc;
            --border: rgba(15, 23, 42, 0.08);
            --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        }

        body {
            font-family: "Source Sans 3", sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at 10% 15%, #dbeafe 0%, transparent 35%),
                radial-gradient(circle at 80% 0%, #fef3c7 0%, transparent 35%),
                #f8fafc;
            margin: 0;
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-family: "Space Grotesk", sans-serif;
            letter-spacing: -0.02em;
        }

        .page-shell {
            position: relative;
            overflow: hidden;
        }

        .site-header {
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(12px);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .stat-pill {
            background: var(--surface-soft);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1rem 1.2rem;
        }

        .toggle-btn {
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #f1f5f9;
            color: var(--ink-muted);
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .toggle-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
        }

        .summary-panel {
            border-left: 4px solid var(--accent);
            background: #eff6ff;
        }

        .summary-panel.warm {
            border-left-color: var(--accent-warm);
            background: #fff7ed;
        }

        .summary-bullets ul {
            list-style: disc;
            padding-left: 1.5rem;
            color: var(--ink-muted);
            font-size: 1rem;
            line-height: 1.7;
        }

        .summary-bullets li {
            margin-bottom: 0.5rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.7rem 1.2rem;
            border-radius: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #38bdf8);
            color: white;
            box-shadow: 0 12px 22px rgba(37, 99, 235, 0.25);
        }

        .modal-shell {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .input-field {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--ink-muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            color: var(--ink);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .logout-btn {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 0.4rem 0.9rem;
            font-weight: 600;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="page-shell">
        <header class="site-header">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Teacher Console</p>
                    <h1 class="text-3xl font-semibold">Teaching Feedback Overview</h1>
                </div>
                <div class="nav-links">
                    <a href="/">Home</a>
                    <a href="/feedback">Feedback</a>
                    <a href="/student_dashboard">Student Dashboard</a>
                    <span id="teacherUser" class="user-pill">Checking session...</span>
                    <button id="logoutBtn" class="logout-btn" type="button">Sign out</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 my-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Key Metrics</h3>
                        <div id="metrics-content" class="space-y-4">
                            <div class="stat-pill flex justify-between items-center">
                                <span class="text-sm text-slate-600">Total feedback received</span>
                                <span id="feedback-count" class="text-3xl font-semibold text-slate-900">--</span>
                            </div>
                            <div class="stat-pill flex justify-between items-center">
                                <span class="text-sm text-slate-600">Last summary update</span>
                                <span id="last-check-in" class="text-base font-semibold text-slate-800">--/--/--</span>
                            </div>
                        </div>
                        <div id="metrics-skeleton" class="space-y-4 hidden">
                            <div class="h-10 bg-slate-200 rounded-xl animate-pulse"></div>
                            <div class="h-10 bg-slate-200 rounded-xl animate-pulse"></div>
                        </div>

                        <button id="clarification-btn" class="action-btn w-full mt-6">
                            Request clarification
                        </button>
                    </div>

                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Clarification history</h2>
                            <div class="flex space-x-2">
                                <button id="teacher-clarification-pending-btn" class="toggle-btn active" data-status="pending">Pending</button>
                                <button id="teacher-clarification-resolved-btn" class="toggle-btn" data-status="resolved">Replied</button>
                            </div>
                        </div>
                        <div id="teacher-clarification-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
                    </div>

                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Announcements</h2>
                            <button id="refreshTeacherAnnouncements" class="toggle-btn">Refresh</button>
                        </div>
                        <div id="teacher-announcement-container" class="space-y-3"></div>
                    </div>

                    <div class="card">
                        <h2 class="text-lg font-semibold mb-2">Teaching practice trends</h2>
                        <p class="text-sm text-slate-500 mb-4">Average student ratings on a 1 to 5 scale.</p>
                        <div class="w-full h-72">
                            <canvas id="trendChart"></canvas>
                            <div id="chart-skeleton" class="bg-slate-200 animate-pulse rounded-xl h-full w-full hidden"></div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 card">
                    <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
                        <h2 class="text-2xl font-semibold">Holistic AI Summary for <span id="teacher-name" class="text-blue-600"></span></h2>
                        <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Private summary</span>
                    </div>
                    <p class="text-sm text-slate-500 bg-slate-50 border border-slate-200 p-3 rounded-2xl mb-6">
                        This summary is anonymized and updates as new approved feedback arrives.
                    </p>

                    <div id="summary-content" class="space-y-8">
                        <div class="summary-panel rounded-2xl p-6 summary-bullets">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3">Positive and neutral highlights</h3>
                            <div id="positive-summary-content"></div>
                        </div>
                        <div class="summary-panel warm rounded-2xl p-6 summary-bullets">
                            <h3 class="text-lg font-semibold text-orange-800 mb-3">Actionable growth opportunities</h3>
                            <div id="actionable-summary-content"></div>
                        </div>
                    </div>

                    <div id="summary-skeleton" class="space-y-6 hidden">
                        <div class="bg-slate-200 animate-pulse rounded-2xl h-48"></div>
                        <div class="bg-slate-200 animate-pulse rounded-2xl h-32"></div>
                    </div>
                </div>
            </div>
        </main>

        <div id="clarification-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 hidden">
            <div class="modal-shell w-full max-w-lg">
                <h3 class="text-2xl font-semibold text-slate-800 mb-3">Ask STUCO for clarification</h3>
                <p class="text-slate-600 mb-4">STUCO will relay your question to protect student anonymity.</p>

                <textarea id="clarification-textarea" rows="4" class="input-field" placeholder="What part of the summary needs clarification?"></textarea>

                <p id="modal-message" class="text-sm font-medium mt-3 hidden"></p>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="modal-cancel-btn" class="toggle-btn">Cancel</button>
                    <button id="modal-submit-btn" class="action-btn">Send to STUCO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const API_STATS_URL = "/api/teacher/stats";
        const API_SUMMARY_URL = "/api/teacher/holistic_summary";
        const API_CLARIFICATION_URL = "/api/clarification_request";
        const API_TEACHER_CLARIFICATIONS_URL = "/api/teacher/clarifications";
        const API_ANNOUNCEMENTS = "/api/announcements";
        const API_AUTH_ME = "/api/auth/me";
        const API_AUTH_LOGOUT = "/api/auth/logout";

        let trendChartInstance = null;

        // --- DOM ELEMENTS ---
        const feedbackCountEl = document.getElementById('feedback-count');
        const lastCheckInEl = document.getElementById('last-check-in');
        const teacherNameEl = document.getElementById('teacher-name');
        const summaryContentEl = document.getElementById('summary-content');
        const positiveSummaryContentEl = document.getElementById('positive-summary-content');
        const actionableSummaryContentEl = document.getElementById('actionable-summary-content');
        const metricsSkeleton = document.getElementById('metrics-skeleton');
        const chartSkeleton = document.getElementById('chart-skeleton');
        const summarySkeleton = document.getElementById('summary-skeleton');
        const clarificationBtn = document.getElementById('clarification-btn');
        const clarificationModal = document.getElementById('clarification-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const clarificationTextarea = document.getElementById('clarification-textarea');
        const modalMessage = document.getElementById('modal-message');
        const teacherClarificationPendingBtn = document.getElementById('teacher-clarification-pending-btn');
        const teacherClarificationResolvedBtn = document.getElementById('teacher-clarification-resolved-btn');
        const teacherClarificationContainer = document.getElementById('teacher-clarification-container');
        const teacherUser = document.getElementById('teacherUser');
        const logoutBtn = document.getElementById('logoutBtn');
        const teacherAnnouncementContainer = document.getElementById('teacher-announcement-container');
        const refreshTeacherAnnouncements = document.getElementById('refreshTeacherAnnouncements');

        // --- UTILITIES ---
        const getAuthQuery = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mockUser = urlParams.get('mock_user_id');
            return mockUser ? `?mock_user_id=${mockUser}` : '';
        };

        const routeByRole = (role) => {
            if (role === 'stuco_admin') {
                window.location.href = '/stuco_admin_dashboard.html';
            } else if (role === 'student') {
                window.location.href = '/student_dashboard';
            } else {
                window.location.href = '/teach_frontend.html';
            }
        };

        const ensureTeacherAccess = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mockUser = urlParams.get('mock_user_id');
            if (mockUser) {
                teacherUser.textContent = `Mock user #${mockUser}`;
                logoutBtn.classList.add('hidden');
                return true;
            }
            try {
                const response = await fetch(API_AUTH_ME);
                if (!response.ok) throw new Error('Not signed in');
                const data = await response.json();
                const user = data.user || {};
                if (user.role !== 'teacher') {
                    routeByRole(user.role);
                    return false;
                }
                teacherUser.textContent = `${user.name || user.email} (Teacher)`;
                return true;
            } catch (error) {
                const next = encodeURIComponent('/teach_frontend.html');
                window.location.href = `/auth.html?next=${next}`;
                return false;
            }
        };

        const setLoadingState = (isLoading) => {
            metricsSkeleton.classList.toggle('hidden', !isLoading);
            chartSkeleton.classList.toggle('hidden', !isLoading);
            summarySkeleton.classList.toggle('hidden', !isLoading);
            document.getElementById('metrics-content').classList.toggle('hidden', isLoading);
            summaryContentEl.classList.toggle('hidden', isLoading);
        };

        const displayApiError = (element, message = "API Error") => {
            element.textContent = message;
            element.classList.add('text-red-500');
        };

        const escapeHtml = (value) => {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        };

        const renderBullets = (bullets, emptyMessage) => {
            const list = Array.isArray(bullets) ? bullets : [];
            if (!list.length) {
                return `<ul><li>${escapeHtml(emptyMessage)}</li></ul>`;
            }
            return `<ul>${list.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`;
        };

        // --- FETCH LOGIC ---
        const fetchStats = async () => {
            try {
                const url = window.location.origin + API_STATS_URL + getAuthQuery();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Server returned ${response.status}`);
                const data = await response.json();
                feedbackCountEl.textContent = data.stats.total_feedback || 0;
                lastCheckInEl.textContent = data.stats.last_check_in || "N/A";
                if (data.trends && data.trends.data) {
                    initChart(data.trends);
                } else {
                    const chartContainer = document.getElementById('chart-skeleton');
                    chartContainer.classList.add('bg-transparent', 'text-center', 'pt-10', 'text-slate-500');
                    chartContainer.innerHTML = 'Data for trends chart is currently unavailable.';
                    chartContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching stats:", error);
                const message = `API Error: ${error.message}`;
                displayApiError(feedbackCountEl, message);
                displayApiError(lastCheckInEl, message);
            }
        };

        const fetchSummary = async () => {
            try {
                const url = window.location.origin + API_SUMMARY_URL + getAuthQuery();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Server returned ${response.status}`);
                const data = await response.json();
                teacherNameEl.textContent = data.teacher_name || "Teacher";
                positiveSummaryContentEl.innerHTML = renderBullets(data.positive_bullets, "No highlights available.");
                actionableSummaryContentEl.innerHTML = renderBullets(data.actionable_bullets, "No opportunities available.");
                summaryContentEl.classList.remove('hidden');
            } catch (error) {
                console.error("Error fetching summary:", error);
                summaryContentEl.classList.remove('hidden');
                const message = `API Error: ${error.message}`;
                positiveSummaryContentEl.innerHTML = `<p class="text-red-600">${escapeHtml(message)}</p>`;
                actionableSummaryContentEl.innerHTML = `<p class="text-red-600">Could not load summary.</p>`;
            }
        };

        const fetchTeacherClarifications = async (status = 'pending') => {
            teacherClarificationPendingBtn.classList.toggle('active', status === 'pending');
            teacherClarificationResolvedBtn.classList.toggle('active', status === 'resolved');

            const url = new URL(window.location.origin + API_TEACHER_CLARIFICATIONS_URL);
            url.searchParams.append('status', status);
            if (getAuthQuery()) url.search = url.search + '&' + getAuthQuery().substring(1);

            try {
                teacherClarificationContainer.innerHTML = `<p class="text-slate-500 text-sm p-4 text-center">Loading...</p>`;
                const response = await fetch(url);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'API error');

                if (data.length > 0) {
                    teacherClarificationContainer.innerHTML = data.map(req => renderTeacherClarificationItem(req, status)).join('');
                } else {
                    teacherClarificationContainer.innerHTML = `<p class="text-slate-500 text-sm p-4 text-center">No ${status} requests.</p>`;
                }
            } catch (error) {
                console.error("Error fetching teacher clarifications:", error);
                teacherClarificationContainer.innerHTML = '<div class="text-center p-4 text-red-500">API error loading history.</div>';
            }
        };

        const fetchTeacherAnnouncements = async () => {
            try {
                teacherAnnouncementContainer.innerHTML = '<p class="text-slate-500 text-sm">Loading announcements...</p>';
                const response = await fetch(`${API_ANNOUNCEMENTS}?audience=teacher&limit=4`);
                if (!response.ok) throw new Error('Failed to load announcements');
                const items = await response.json();
                if (!items.length) {
                    teacherAnnouncementContainer.innerHTML = '<p class="text-slate-500 text-sm">No announcements yet.</p>';
                    return;
                }
                teacherAnnouncementContainer.innerHTML = items.map(item => `
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="flex items-center justify-between gap-3 flex-wrap">
                            <h3 class="text-base font-semibold text-slate-800">${escapeHtml(item.title)}</h3>
                            <span class="text-xs text-slate-500">${new Date(item.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="text-sm text-slate-600 mt-2 whitespace-pre-wrap">${escapeHtml(item.body)}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error("Error fetching announcements:", error);
                teacherAnnouncementContainer.innerHTML = '<p class="text-red-500 text-sm">Announcements unavailable.</p>';
            }
        };

        const renderTeacherClarificationItem = (req, status) => {
            const isPending = (status === 'pending');
            return `
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <p class="font-semibold text-sm ${isPending ? 'text-orange-700' : 'text-green-700'}">${isPending ? 'Pending' : 'Replied'}</p>
                    <span class="text-xs text-slate-500">${new Date(req.requested_on).toLocaleDateString()}</span>
                </div>
                <p class="text-sm font-semibold text-slate-500">Your question</p>
                <p class="text-sm text-slate-800 bg-white p-3 rounded-xl mb-2 whitespace-pre-wrap">${escapeHtml(req.question_text)}</p>
                ${!isPending ? `
                <p class="text-sm font-semibold text-slate-500 mt-3">STUCO reply</p>
                <p class="text-sm text-slate-800 bg-blue-50 border border-blue-100 p-3 rounded-xl whitespace-pre-wrap">${escapeHtml(req.admin_reply)}</p>
                ` : ''}
            </div>`;
        };

        const loadAllData = async () => {
            setLoadingState(true);
            await Promise.all([
                fetchStats(),
                fetchSummary(),
                fetchTeacherClarifications('pending')
            ]);
            setLoadingState(false);
        };

        // --- CHART LOGIC ---
        const initChart = (trendData) => {
            const ctx = document.getElementById('trendChart').getContext('2d');
            Chart.defaults.font.family = 'Source Sans 3, sans-serif';

            const labels = trendData.labels;
            const dataScores = trendData.data;
            const accentColor = '#2563eb';
            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Score (out of 5)',
                        data: dataScores,
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.15)',
                        borderColor: accentColor,
                        pointBackgroundColor: accentColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: accentColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: { line: { borderWidth: 3 } },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(100, 116, 139, 0.2)' },
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            pointLabels: { font: { size: 12, family: 'Source Sans 3' } },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            ticks: { display: true, stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.8)',
                            titleFont: { family: 'Source Sans 3' },
                            bodyFont: { family: 'Source Sans 3' }
                        }
                    }
                }
            });
        };

        // --- MODAL LOGIC ---
        const handleModalSubmit = async () => {
            const question_text = clarificationTextarea.value.trim();
            if (question_text.length < 10) {
                modalMessage.textContent = "Please provide a more detailed question (min 10 characters).";
                modalMessage.classList.remove('hidden', 'text-green-600');
                modalMessage.classList.add('text-red-500');
                return;
            }
            modalSubmitBtn.disabled = true;
            modalSubmitBtn.textContent = 'Sending...';
            modalMessage.classList.add('hidden');
            try {
                const url = window.location.origin + API_CLARIFICATION_URL + getAuthQuery();
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_text })
                });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'Server error');
                }
                modalMessage.textContent = "Request sent successfully!";
                modalMessage.classList.remove('hidden', 'text-red-500');
                modalMessage.classList.add('text-green-600');
                clarificationTextarea.value = '';

                fetchTeacherClarifications('pending');

                setTimeout(() => clarificationModal.classList.add('hidden'), 1800);
            } catch (error) {
                modalMessage.textContent = `Error: ${error.message}. Please try again.`;
                modalMessage.classList.remove('hidden', 'text-green-600');
                modalMessage.classList.add('text-red-500');
            } finally {
                modalSubmitBtn.disabled = false;
                modalSubmitBtn.textContent = 'Send to STUCO';
            }
        };

        // --- INITIALIZATION & LISTENERS ---
        document.addEventListener('DOMContentLoaded', async () => {
            const allowed = await ensureTeacherAccess();
            if (!allowed) return;
            loadAllData();
            fetchTeacherAnnouncements();
            clarificationBtn.addEventListener('click', () => {
                clarificationTextarea.value = '';
                modalMessage.textContent = '';
                modalMessage.classList.add('hidden');
                clarificationModal.classList.remove('hidden');
            });
            modalCancelBtn.addEventListener('click', () => clarificationModal.classList.add('hidden'));
            modalSubmitBtn.addEventListener('click', handleModalSubmit);

            teacherClarificationPendingBtn.addEventListener('click', () => fetchTeacherClarifications('pending'));
            teacherClarificationResolvedBtn.addEventListener('click', () => fetchTeacherClarifications('resolved'));
            refreshTeacherAnnouncements.addEventListener('click', fetchTeacherAnnouncements);

            logoutBtn.addEventListener('click', async () => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('mock_user_id')) {
                    window.location.href = '/';
                    return;
                }
                await fetch(API_AUTH_LOGOUT, { method: 'POST' });
                window.location.href = '/';
            });
        });
    </script>
</body>
</html>
