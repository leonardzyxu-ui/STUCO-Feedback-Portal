<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="icon" href="/static/logo.png?v=2" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'stuco-blue': {
                          '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a', '950': '#172554',
                        },
                        'stuco-dark': '#111827',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #f0f5ff; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
        }
        .main-card {
             background-color: rgba(255, 255, 255, 0.9);
             backdrop-filter: blur(10px);
        }
        #positive-summary-content ul, #actionable-summary-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            color: #374151; /* text-gray-700 */
            font-size: 1.05rem;
            line-height: 1.6;
        }
        #positive-summary-content li, #actionable-summary-content li {
            margin-bottom: 0.5rem;
        }
        .toggle-btn { @apply px-3 py-1 text-sm font-semibold text-gray-600 bg-gray-200 rounded-lg transition; }
        .toggle-btn.active { @apply bg-stuco-blue-600 text-white shadow-inner; }
    </style>
</head>
<body class="font-sans">
    <header class="bg-white/90 shadow-lg border-b border-stuco-blue-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <h1 class="text-3xl font-extrabold text-stuco-blue-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 mr-3">
                     <path d="M11.7 2.805a.75.75 0 0 1 .6 0A7.25 7.25 0 0 0 21.75 10.5c0 1.952-.72 3.823-2.096 5.342.348.455.676.924.974 1.41l.235.378c.328.528.188 1.18-.35 1.442l-2.029.972c-1.396.671-3.03.966-4.708.814-1.87-.168-3.66-1.12-4.996-2.617C6.672 12.182 6 9.68 6 7.02c0-2.327 1.13-4.52 3.033-5.836ZM12 4.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" />
                     <path fill-rule="evenodd" d="M12 18a1 1 0 0 0-1 1v2a1 1 0 0 0 2 0v-2a1 1 0 0 0-1-1Z" clip-rule="evenodd" />
                </svg>
                Teacher Dashboard
            </h1>
            <a href="/" class="text-sm font-semibold text-stuco-dark hover:text-stuco-blue-700 transition">Student Portal</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 my-12">
         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                 <div class="main-card p-6 rounded-3xl shadow-xl border border-gray-200/80">
                    <h3 class="text-xl font-bold text-stuco-dark mb-4 border-b border-gray-100 pb-3">Key Metrics</h3>
                    <div id="metrics-content">
                        <div class="flex justify-between items-center p-4 bg-stuco-blue-50/70 rounded-2xl mb-4">
                            <span class="text-base text-gray-600 font-medium">Total Feedback Received</span>
                            <span id="feedback-count" class="text-3xl font-extrabold text-stuco-blue-600">--</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                            <span class="text-base text-gray-600 font-medium">Last Summary Update</span>
                            <span id="last-check-in" class="text-lg font-semibold text-stuco-dark">--/--/--</span>
                        </div>
                    </div>
                     <div id="metrics-skeleton" class="space-y-4 hidden">
                        <div class="h-10 bg-gray-200 rounded-xl animate-pulse"></div>
                        <div class="h-10 bg-gray-200 rounded-xl animate-pulse"></div>
                    </div>
                    
                    <button id="clarification-btn" class="w-full py-2.5 mt-4 bg-yellow-500 text-white font-semibold rounded-2xl shadow-md hover:bg-yellow-600 transition">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block mr-2">
                             <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0ZM8.94 9.176a.75.75 0 0 0-1.06-1.061l-2.492 2.491a.75.75 0 1 0 1.06 1.06l2.491-2.49Z" clip-rule="evenodd" />
                             <path d="M13.25 10a.75.75 0 0 0 0 1.5.75.75 0 0 0 0-1.5Z" />
                        </svg>
                        Request Clarification
                    </button>
                </div>
                
                <div class="main-card p-6 rounded-3xl shadow-xl border border-gray-200/80">
                    <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-3">
                        <h2 class="text-xl font-bold text-stuco-dark">My Clarification History</h2>
                        <div class="flex space-x-2">
                            <button id="teacher-clarification-pending-btn" class="toggle-btn active" data-status="pending">Pending</button>
                            <button id="teacher-clarification-resolved-btn" class="toggle-btn" data-status="resolved">Replied</button>
                        </div>
                    </div>
                    <div id="teacher-clarification-container" class="space-y-4 max-h-96 overflow-y-auto">
                        </div>
                </div>

                <div class="main-card p-6 rounded-3xl shadow-xl border border-gray-200/80">
                    <h2 class="text-xl font-bold text-stuco-dark mb-2">Teaching Practice Trends</h2>
                    <p class="text-sm text-gray-500 mb-4">Average student ratings (1-5 scale).</p>
                     <div class="w-full h-72">
                         <canvas id="trendChart"></canvas>
                         <div id="chart-skeleton" class="bg-gray-200 animate-pulse rounded-xl h-full w-full hidden"></div>
                    </div>
                </div>
            </div>

             <div class="lg:col-span-2 main-card p-8 rounded-3xl shadow-xl border border-stuco-blue-200/80">
                <h2 class="text-2xl font-bold text-stuco-dark mb-4">Holistic AI Summary for <span id="teacher-name" class="text-stuco-blue-600"></span></h2>
                <p class="text-sm text-red-600 bg-red-50/80 border border-red-200 p-3 rounded-2xl mb-6">
                    <strong>Privacy Notice:</strong> This is an anonymized, holistic summary of all student feedback. This report will update in the background as new feedback is received.
                </p>
                
                <div id="summary-content" class="space-y-8">
                    <div class="p-6 bg-green-50/80 border-l-4 border-green-500 rounded-2xl shadow-sm">
                        <h3 class="text-xl font-semibold text-green-800 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM9.53 7.185A2.25 2.25 0 0 1 12 9.5v.251a.75.75 0 0 0 1.5 0v-.251a3.75 3.75 0 1 0-7.472-1.284.75.75 0 1 0 1.341.597 2.25 2.25 0 0 1 4.532.709Z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 1 .5-.5Z" clip-rule="evenodd" />
                            </svg>
                            Positive & Neutral Highlights
                        </h3>
                        <div id="positive-summary-content" class="text-lg text-gray-800 leading-relaxed"></div>
                    </div>
                    
                    <div class="p-6 bg-yellow-50/80 border-l-4 border-yellow-500 rounded-2xl shadow-sm">
                        <h3 class="text-xl font-semibold text-yellow-800 mb-4 flex items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                                 <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM5.47 7.027a.75.75 0 0 1 1.06 0L10 10.487l3.47-3.46a.75.75 0 0 1 1.06 1.06l-4 4a.75.75 0 0 1-1.06 0l-4-4a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                            </svg>
                            Actionable Growth Opportunities
                        </h3>
                        <div id="actionable-summary-content" class="text-lg text-gray-800 leading-relaxed"></div>
                    </div>
                </div>
                
                <div id="summary-skeleton" class="space-y-6 hidden">
                    <div class="bg-gray-200 animate-pulse rounded-2xl h-48"></div>
                    <div class="bg-gray-200 animate-pulse rounded-2xl h-32"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="clarification-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4 hidden">
       <div class="bg-white p-8 rounded-3xl w-full max-w-lg shadow-2xl">
            <h3 class="text-2xl font-bold text-stuco-blue-600 mb-4">Ask STUCO for Clarification</h3>
            <p class="text-gray-600 mb-4">Use this form if a summary is unclear. STUCO will act as the intermediary to preserve student anonymity.</p>

            <textarea id="clarification-textarea" rows="4" class="w-full border-gray-300 rounded-xl p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="E.g., Which specific resource was confusing for students in the 'Resources' category?"></textarea>
            
            <p id="modal-message" class="text-sm font-medium mt-3 hidden"></p>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="modal-cancel-btn" class="py-2 px-4 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                <button id="modal-submit-btn" class="py-2 px-4 bg-stuco-blue-600 text-white rounded-xl font-semibold hover:bg-stuco-blue-700 transition">Send to STUCO</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONSTANTS ---
        const API_STATS_URL = "/api/teacher/stats"; 
        const API_SUMMARY_URL = "/api/teacher/holistic_summary"; 
        const API_CLARIFICATION_URL = "/api/clarification_request"; 
        const API_TEACHER_CLARIFICATIONS_URL = "/api/teacher/clarifications"; 
        
        let trendChartInstance = null;
        
        // --- DOM ELEMENTS ---
        const feedbackCountEl = document.getElementById('feedback-count');
        const lastCheckInEl = document.getElementById('last-check-in');
        const teacherNameEl = document.getElementById('teacher-name');
        const summaryContentEl = document.getElementById('summary-content');
        const positiveSummaryContentEl = document.getElementById('positive-summary-content');
        const actionableSummaryContentEl = document.getElementById('actionable-summary-content');
        const metricsSkeleton = document.getElementById('metrics-skeleton');
        const chartSkeleton = document.getElementById('chart-skeleton');
        const summarySkeleton = document.getElementById('summary-skeleton');
        const clarificationBtn = document.getElementById('clarification-btn');
        const clarificationModal = document.getElementById('clarification-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const clarificationTextarea = document.getElementById('clarification-textarea');
        const modalMessage = document.getElementById('modal-message');
        const teacherClarificationPendingBtn = document.getElementById('teacher-clarification-pending-btn');
        const teacherClarificationResolvedBtn = document.getElementById('teacher-clarification-resolved-btn');
        const teacherClarificationContainer = document.getElementById('teacher-clarification-container');
        
        
        // --- UTILITY ---
        const getAuthQuery = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mockUser = urlParams.get('mock_user_id');
            return mockUser ? `?mock_user_id=${mockUser}` : '';
        }
        const setLoadingState = (isLoading) => {
            metricsSkeleton.classList.toggle('hidden', !isLoading);
            chartSkeleton.classList.toggle('hidden', !isLoading);
            summarySkeleton.classList.toggle('hidden', !isLoading);
            document.getElementById('metrics-content').classList.toggle('hidden', isLoading);
            summaryContentEl.classList.toggle('hidden', isLoading);
        };
        const displayApiError = (element, message = "API Error") => {
            element.textContent = message;
            element.classList.add('text-red-500');
        };
        
        // --- FETCH LOGIC ---
        const fetchStats = async () => {
            try {
                const url = window.location.origin + API_STATS_URL + getAuthQuery();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Server returned ${response.status}`);
                const data = await response.json();
                feedbackCountEl.textContent = data.stats.total_feedback || 0;
                lastCheckInEl.textContent = data.stats.last_check_in || "N/A";
                if (data.trends && data.trends.data) {
                    initChart(data.trends);
                } else {
                    console.warn("Trends data missing from API response.");
                    const chartContainer = document.getElementById('chart-skeleton');
                    chartContainer.classList.add('bg-transparent', 'text-center', 'pt-10', 'text-gray-500');
                    chartContainer.innerHTML = 'Data for trends chart is currently unavailable.';
                    chartContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching stats:", error);
                const message = `API Error: ${error.message}`;
                displayApiError(feedbackCountEl, message);
                displayApiError(lastCheckInEl, message);
            }
        };
        const fetchSummary = async () => {
            try {
                const url = window.location.origin + API_SUMMARY_URL + getAuthQuery(); 
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Server returned ${response.status}`);
                const data = await response.json();
                teacherNameEl.textContent = data.teacher_name || "Teacher";
                positiveSummaryContentEl.innerHTML = data.positive_summary || "<ul><li>No highlights available.</li></ul>";
                actionableSummaryContentEl.innerHTML = data.actionable_summary || "<ul><li>No opportunities available.</li></ul>";
                summaryContentEl.classList.remove('hidden');
            } catch (error) {
                console.error("Error fetching summary:", error);
                summaryContentEl.classList.remove('hidden');
                const message = `API Error: ${error.message}`;
                positiveSummaryContentEl.innerHTML = `<p class="text-red-600">${message}</p>`;
                actionableSummaryContentEl.innerHTML = `<p class="text-red-600">Could not load summary.</p>`;
            }
        };
        
        const fetchTeacherClarifications = async (status = 'pending') => {
             teacherClarificationPendingBtn.classList.toggle('active', status === 'pending');
             teacherClarificationResolvedBtn.classList.toggle('active', status === 'resolved');
             
             const url = new URL(window.location.origin + API_TEACHER_CLARIFICATIONS_URL);
             url.searchParams.append('status', status);
             if (getAuthQuery()) url.search = url.search + '&' + getAuthQuery().substring(1);

             try {
                teacherClarificationContainer.innerHTML = `<p class="text-gray-500 text-sm p-4 text-center">Loading...</p>`;
                const response = await fetch(url);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'API error');
                
                if (data.length > 0) {
                    teacherClarificationContainer.innerHTML = data.map(req => renderTeacherClarificationItem(req, status)).join('');
                } else {
                    teacherClarificationContainer.innerHTML = `<p class="text-gray-500 text-sm p-4 text-center">No ${status} requests.</p>`;
                }
            } catch (error) {
                console.error("Error fetching teacher clarifications:", error);
                teacherClarificationContainer.innerHTML = '<div class="text-center p-4 text-red-500">API error loading history.</div>';
            }
        };
        
        const renderTeacherClarificationItem = (req, status) => {
            const isPending = (status === 'pending');
            return `
            <div class="bg-gray-50 p-4 rounded-xl shadow-sm border-l-4 ${isPending ? 'border-yellow-500' : 'border-green-500'}">
                <div class="flex justify-between items-center mb-2">
                    <p class="font-semibold text-sm ${isPending ? 'text-yellow-700' : 'text-green-700'}">${isPending ? 'Pending' : 'Replied'}</p>
                    <span class="text-xs text-gray-500">${new Date(req.requested_on).toLocaleDateString()}</span>
                </div>
                <p class="text-sm font-semibold text-gray-500">Your Question:</p>
                <p class="text-sm text-gray-800 bg-gray-100 p-3 rounded-lg mb-2 whitespace-pre-wrap">${req.question_text}</p>
                ${!isPending ? `
                <p class="text-sm font-semibold text-gray-500 mt-3">STUCO Reply:</p>
                <p class="text-sm text-gray-800 bg-stuco-blue-50 border border-stuco-blue-200 p-3 rounded-lg whitespace-pre-wrap">${req.admin_reply}</p>
                ` : ''}
            </div>`;
        }
        
        const loadAllData = async () => {
            setLoadingState(true);
            // Load all data in parallel
            await Promise.all([
                fetchStats(), 
                fetchSummary(),
                fetchTeacherClarifications('pending') // Load default pending list
            ]);
            setLoadingState(false);
        };

        // --- CHART LOGIC ---
        const initChart = (trendData) => {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // --- FIX #4: Use labels from API ---
            const labels = trendData.labels;
            const dataScores = trendData.data;
            
            const accentColor = '#2563eb'; 
            if (trendChartInstance) trendChartInstance.destroy();
            
            trendChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Score (out of 5)',
                        data: dataScores,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                        borderColor: accentColor,
                        pointBackgroundColor: accentColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: accentColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: { line: { borderWidth: 3 } },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(100, 100, 100, 0.2)' },
                            grid: { color: 'rgba(100, 100, 100, 0.2)' },
                            pointLabels: { font: { size: 12, family: 'Inter' } },
                            suggestedMin: 0, 
                            suggestedMax: 5,
                            ticks: { display: true, stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             backgroundColor: 'rgba(0, 0, 0, 0.8)',
                             titleFont: { family: 'Inter' },
                             bodyFont: { family: 'Inter' },
                        }
                    }
                }
            });
        };
        
        // --- MODAL LOGIC ---
        const handleModalSubmit = async () => {
            const question_text = clarificationTextarea.value.trim();
            if (question_text.length < 10) {
                 modalMessage.textContent = "Please provide a more detailed question (min 10 characters).";
                 modalMessage.classList.remove('hidden', 'text-green-600');
                 modalMessage.classList.add('text-red-500');
                 return;
            }
            modalSubmitBtn.disabled = true;
            modalSubmitBtn.textContent = 'Sending...';
            modalMessage.classList.add('hidden'); 
            try {
                const url = window.location.origin + API_CLARIFICATION_URL + getAuthQuery(); 
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_text })
                });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'Server error');
                }
                modalMessage.textContent = "Request sent successfully! STUCO will review your question.";
                modalMessage.classList.remove('hidden', 'text-red-500');
                modalMessage.classList.add('text-green-600');
                clarificationTextarea.value = '';
                
                fetchTeacherClarifications('pending');
                
                setTimeout(() => clarificationModal.classList.add('hidden'), 2000);
            } catch (error) {
                modalMessage.textContent = `Error: ${error.message}. Please try again.`;
                modalMessage.classList.remove('hidden', 'text-green-600');
                modalMessage.classList.add('text-red-500');
            } finally {
                modalSubmitBtn.disabled = false;
                modalSubmitBtn.textContent = 'Send to STUCO';
            }
        };

        // --- INITIALIZATION & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            clarificationBtn.addEventListener('click', () => {
                clarificationTextarea.value = '';
                modalMessage.textContent = '';
                modalMessage.classList.add('hidden');
                clarificationModal.classList.remove('hidden');
            });
            modalCancelBtn.addEventListener('click', () => clarificationModal.classList.add('hidden'));
            modalSubmitBtn.addEventListener('click', handleModalSubmit);
            
            teacherClarificationPendingBtn.addEventListener('click', () => fetchTeacherClarifications('pending'));
            teacherClarificationResolvedBtn.addEventListener('click', () => fetchTeacherClarifications('resolved'));
        });
    </script>
</body>
</html>