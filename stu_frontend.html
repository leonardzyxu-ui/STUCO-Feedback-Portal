<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Feedback Studio</title>
    <link rel="icon" href="/static/logo.png?v=2" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ink: #1f2933;
            --ink-muted: #52606d;
            --accent: #0ea5a6;
            --accent-strong: #0f766e;
            --accent-warm: #f97316;
            --accent-soft: #fff2e7;
            --surface: #ffffff;
            --surface-soft: #f8fafc;
            --border: rgba(15, 23, 42, 0.08);
            --shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Source Sans 3", sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at 10% 10%, #fef3c7 0%, transparent 35%),
                radial-gradient(circle at 90% 0%, #dbeafe 0%, transparent 35%),
                radial-gradient(circle at 80% 90%, #dcfce7 0%, transparent 40%),
                #f7f3ee;
            min-height: 100vh;
            margin: 0;
        }

        h1, h2, h3, h4 {
            font-family: "Space Grotesk", sans-serif;
            letter-spacing: -0.02em;
        }

        .page-shell {
            position: relative;
            overflow: hidden;
        }

        .site-header {
            padding: 1.8rem 0 1rem;
        }

        .container {
            width: min(1140px, 92vw);
            margin: 0 auto;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.85rem;
        }

        .logo-mark {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent), #22d3ee);
            box-shadow: 0 10px 20px rgba(14, 165, 166, 0.3);
            display: grid;
            place-items: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--ink);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.85rem;
            border-radius: 999px;
            background: rgba(15, 118, 110, 0.12);
            color: var(--accent-strong);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-pill {
            background: rgba(15, 23, 42, 0.08);
            color: var(--ink);
        }

        .hero {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2rem;
            align-items: center;
            margin-top: 1rem;
        }

        .hero-card {
            background: var(--surface);
            border-radius: 28px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .hero-card ul {
            margin: 0;
            padding-left: 1.1rem;
            color: var(--ink-muted);
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .btn {
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 16px;
            padding: 0.9rem 1.4rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-family: "Space Grotesk", sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #22d3ee);
            color: white;
            box-shadow: 0 14px 24px rgba(14, 165, 166, 0.25);
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--ink);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .section-title {
            margin: 2.5rem 0 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
        }

        .category-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 1.4rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            text-align: left;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.12);
        }

        .category-icon {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: var(--accent-soft);
            color: var(--accent-strong);
        }

        .category-card h4 {
            margin: 0;
            font-size: 1.05rem;
        }

        .category-card p {
            margin: 0;
            color: var(--ink-muted);
            font-size: 0.95rem;
        }

        .hidden-page {
            display: none !important;
        }

        .form-shell {
            background: var(--surface);
            border-radius: 30px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--accent-strong);
            font-weight: 600;
        }

        .form-header {
            margin: 1rem 0 2rem;
        }

        .form-header p {
            color: var(--ink-muted);
        }

        .field {
            width: 100%;
            padding: 0.85rem 1rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            font-size: 1rem;
            color: var(--ink);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 166, 0.2);
        }

        .section-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.25rem;
        }

        .collapsible {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
        }

        .collapsible.is-open {
            max-height: 800px;
            opacity: 1;
        }

        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 0.1rem;
        }

        .star-rating input[type="radio"] {
            display: none;
        }

        .star-rating label {
            color: #cbd5f5;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label {
            color: var(--accent-warm);
        }

        .toggle {
            width: 56px;
            height: 30px;
            background: #cbd5e1;
            border-radius: 999px;
            position: relative;
            transition: background 0.2s ease;
        }

        .toggle span {
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 999px;
            position: absolute;
            top: 4px;
            left: 4px;
            transition: transform 0.2s ease;
            box-shadow: 0 6px 12px rgba(15, 23, 42, 0.2);
        }

        .toggle.active {
            background: var(--accent);
        }

        .toggle.active span {
            transform: translateX(26px);
        }

        .alert {
            margin-top: 1.5rem;
            padding: 0.9rem 1.1rem;
            border-radius: 16px;
            font-weight: 600;
        }

        .alert-success { background: #dcfce7; color: #166534; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-warning { background: #ffedd5; color: #9a3412; }
        .alert-info { background: #dbeafe; color: #1d4ed8; }

        .reveal {
            opacity: 0;
            animation: fadeUp 0.7s ease forwards;
        }

        .feed-list {
            display: grid;
            gap: 1rem;
        }

        .feed-card {
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 1.2rem;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.7rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .badge.green { background: #dcfce7; color: #166534; }
        .badge.red { background: #fee2e2; color: #991b1b; }
        .badge.gray { background: #e2e8f0; color: #475569; }
        .badge.blue { background: #dbeafe; color: #1d4ed8; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 640px) {
            .hero-actions { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
    <link rel="stylesheet" href="/static/theme.css">
</head>
<body>
    <div class="page-shell">
        <header class="site-header">
            <div class="container header-row">
                <div class="brand">
                    <div class="logo-mark">S</div>
                    <div>
                        <p class="text-sm uppercase tracking-[0.25em] text-slate-400">STUCO</p>
                        <h1 class="text-2xl font-semibold">Student Feedback Studio</h1>
                    </div>
                </div>
                <div class="nav-links">
                    <a href="/">Home</a>
                    <a href="/student_dashboard">Dashboard</a>
                    <span id="userPill" class="pill user-pill">Checking session...</span>
                    <button id="logoutBtn" class="btn btn-secondary" type="button">Sign out</button>
                </div>
            </div>
        </header>

        <main class="container pb-16">
            <section id="homeScreen" class="reveal">
                <div class="hero">
                    <div>
                        <h2 class="text-4xl sm:text-5xl font-bold leading-tight">Pick a topic. Share the detail. We do the routing.</h2>
                        <p class="mt-4 text-lg text-slate-600">This is the dedicated feedback hub. Choose a category, fill the form, and STUCO handles the rest.</p>
                        <div class="hero-actions">
                            <button id="primaryCategoryBtn" class="btn btn-primary nav-btn" data-category="">Loading...</button>
                            <button id="secondaryCategoryBtn" class="btn btn-secondary nav-btn" data-category="">Loading...</button>
                        </div>
                    </div>
                    <div class="hero-card">
                        <h3 class="text-xl font-semibold">What happens next</h3>
                        <ul class="mt-4">
                            <li>AI screens for unsafe language.</li>
                            <li>STUCO reviews approved feedback.</li>
                            <li>Teachers receive summary insights.</li>
                        </ul>
                    </div>
                </div>

                <div class="section-title">Choose a topic</div>
                <div id="categoryGrid" class="category-grid">
                    <div class="category-card">Loading categories...</div>
                </div>

                <div class="section-title">Recent submissions</div>
                <div id="recentFeedback" class="feed-list">
                    <div class="feed-card">Loading your recent feedback...</div>
                </div>
            </section>

            <section id="formContainer" class="hidden-page">
                <div class="form-shell">
                    <button id="backButton" class="back-btn" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path d="M14.7 6.7a1 1 0 0 1 0 1.4L11.82 11h8.68a1 1 0 1 1 0 2h-8.68l2.88 2.9a1 1 0 1 1-1.4 1.4l-4.6-4.6a1 1 0 0 1 0-1.4l4.6-4.6a1 1 0 0 1 1.4 0Z" />
                        </svg>
                        Back to topics
                    </button>

                    <div class="form-header">
                        <h2 class="text-3xl font-semibold">Submission: <span id="currentCategoryTitle"></span></h2>
                        <p>Stay constructive and clear. This stays anonymous unless flagged for safety review.</p>
                    </div>

                    <form id="feedbackForm" class="space-y-6">
                        <input type="hidden" id="selectedCategory" name="selectedCategory">

                        <div id="teacherFieldsContainer" class="collapsible">
                            <div class="section-card space-y-4">
                                <p class="font-semibold text-slate-700">1. Teacher-specific details</p>
                                <div>
                                    <label for="yearLevel" class="block text-sm font-medium text-slate-600 mb-2">Year level</label>
                                    <select id="yearLevel" class="field">
                                        <option value="" disabled selected>Select year level</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="teacherId" class="block text-sm font-medium text-slate-600 mb-2">Teacher name</label>
                                    <select id="teacherId" class="field" disabled>
                                        <option value="" disabled selected>Select teacher</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="teacherRatingsContainer" class="collapsible">
                            <div class="section-card space-y-4">
                                <p class="font-semibold text-slate-700">2. Optional ratings</p>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                    <label class="block text-base font-medium text-slate-600">Clarity</label>
                                    <div class="star-rating" data-rating-for="clarity">
                                        <input type="radio" id="clarity-5" name="rating-clarity" value="5" /><label for="clarity-5" title="5 stars">&#9733;</label>
                                        <input type="radio" id="clarity-4" name="rating-clarity" value="4" /><label for="clarity-4" title="4 stars">&#9733;</label>
                                        <input type="radio" id="clarity-3" name="rating-clarity" value="3" /><label for="clarity-3" title="3 stars">&#9733;</label>
                                        <input type="radio" id="clarity-2" name="rating-clarity" value="2" /><label for="clarity-2" title="2 stars">&#9733;</label>
                                        <input type="radio" id="clarity-1" name="rating-clarity" value="1" /><label for="clarity-1" title="1 star">&#9733;</label>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                    <label class="block text-base font-medium text-slate-600">Pacing</label>
                                    <div class="star-rating" data-rating-for="pacing">
                                        <input type="radio" id="pacing-5" name="rating-pacing" value="5" /><label for="pacing-5" title="5 stars">&#9733;</label>
                                        <input type="radio" id="pacing-4" name="rating-pacing" value="4" /><label for="pacing-4" title="4 stars">&#9733;</label>
                                        <input type="radio" id="pacing-3" name="rating-pacing" value="3" /><label for="pacing-3" title="3 stars">&#9733;</label>
                                        <input type="radio" id="pacing-2" name="rating-pacing" value="2" /><label for="pacing-2" title="2 stars">&#9733;</label>
                                        <input type="radio" id="pacing-1" name="rating-pacing" value="1" /><label for="pacing-1" title="1 star">&#9733;</label>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                    <label class="block text-base font-medium text-slate-600">Resources</label>
                                    <div class="star-rating" data-rating-for="resources">
                                        <input type="radio" id="resources-5" name="rating-resources" value="5" /><label for="resources-5" title="5 stars">&#9733;</label>
                                        <input type="radio" id="resources-4" name="rating-resources" value="4" /><label for="resources-4" title="4 stars">&#9733;</label>
                                        <input type="radio" id="resources-3" name="rating-resources" value="3" /><label for="resources-3" title="3 stars">&#9733;</label>
                                        <input type="radio" id="resources-2" name="rating-resources" value="2" /><label for="resources-2" title="2 stars">&#9733;</label>
                                        <input type="radio" id="resources-1" name="rating-resources" value="1" /><label for="resources-1" title="1 star">&#9733;</label>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                    <label class="block text-base font-medium text-slate-600">Support</label>
                                    <div class="star-rating" data-rating-for="support">
                                        <input type="radio" id="support-5" name="rating-support" value="5" /><label for="support-5" title="5 stars">&#9733;</label>
                                        <input type="radio" id="support-4" name="rating-support" value="4" /><label for="support-4" title="4 stars">&#9733;</label>
                                        <input type="radio" id="support-3" name="rating-support" value="3" /><label for="support-3" title="3 stars">&#9733;</label>
                                        <input type="radio" id="support-2" name="rating-support" value="2" /><label for="support-2" title="2 stars">&#9733;</label>
                                        <input type="radio" id="support-1" name="rating-support" value="1" /><label for="support-1" title="1 star">&#9733;</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="generalFieldsContainer" class="collapsible">
                            <div class="section-card space-y-4">
                                <p class="font-semibold text-slate-700">1. Context (optional)</p>
                                <div>
                                    <label for="contextField" id="contextLabel" class="block text-sm font-medium text-slate-600 mb-2">Relevant detail</label>
                                    <input type="text" id="contextField" class="field" maxlength="255" placeholder="Add a brief detail if needed" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="feedbackText" class="block text-sm font-semibold text-slate-700 mb-2">
                                <span id="feedback-text-label-number">2</span>. Feedback (required)
                            </label>
                            <textarea id="feedbackText" rows="6" class="field" maxlength="2000" placeholder="Share specific, constructive feedback..."></textarea>
                        </div>

                        <div class="section-card flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                            <div>
                                <strong class="text-base text-slate-700">Anonymity control</strong>
                                <p class="text-sm text-slate-500 mt-1">Share your name if you want, otherwise stay anonymous.</p>
                            </div>
                            <div id="shareNameToggleInner" class="toggle" role="switch" aria-checked="false">
                                <span id="shareNameToggleKnobInner"></span>
                            </div>
                        </div>

                        <button type="submit" id="submitBtnInner" class="btn btn-primary w-full">Submit feedback</button>
                        <div id="submissionMessageInner" class="alert hidden" role="alert"></div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- CONSTANTS ---
        const API_SUBMIT_URL = "/api/submit_feedback";
        const API_TEACHERS_URL = "/api/teachers";
        const API_AUTH_ME = "/api/auth/me";
        const API_AUTH_LOGOUT = "/api/auth/logout";
        const API_STUDENT_FEEDBACK = "/api/student/feedback";
        const API_CATEGORIES = "/api/categories";
        const YEAR_LEVEL_OPTIONS = ["Year 6", "Year 7", "Year 8"];
        const RATING_CATEGORIES = ['clarity', 'pacing', 'resources', 'support'];
        let currentRatings = { clarity: null, pacing: null, resources: null, support: null };
        let categoryMap = {};

        // --- DOM ELEMENTS ---
        const homeScreen = document.getElementById('homeScreen');
        const formContainer = document.getElementById('formContainer');
        const backButton = document.getElementById('backButton');
        const currentCategoryTitle = document.getElementById('currentCategoryTitle');
        const selectedCategoryInput = document.getElementById('selectedCategory');
        const form = document.getElementById('feedbackForm');
        const submitBtn = document.getElementById('submitBtnInner');
        const yearLevelSelect = document.getElementById('yearLevel');
        const teacherSelect = document.getElementById('teacherId');
        const feedbackText = document.getElementById('feedbackText');
        const contextField = document.getElementById('contextField');
        const teacherFieldsContainer = formContainer.querySelector('#teacherFieldsContainer');
        const generalFieldsContainer = formContainer.querySelector('#generalFieldsContainer');
        const teacherRatingsContainer = formContainer.querySelector('#teacherRatingsContainer');
        const feedbackTextLabelNumber = document.getElementById('feedback-text-label-number');
        const starRatingGroups = document.querySelectorAll('.star-rating');
        const contextLabel = document.getElementById('contextLabel');
        const submissionMessage = document.getElementById('submissionMessageInner');
        const shareNameToggleInner = document.getElementById('shareNameToggleInner');
        const shareNameToggleKnobInner = document.getElementById('shareNameToggleKnobInner');
        const userPill = document.getElementById('userPill');
        const logoutBtn = document.getElementById('logoutBtn');
        const recentFeedback = document.getElementById('recentFeedback');
        const primaryCategoryBtn = document.getElementById('primaryCategoryBtn');
        const secondaryCategoryBtn = document.getElementById('secondaryCategoryBtn');
        const categoryGrid = document.getElementById('categoryGrid');
        let shareName = false;

        // --- UTILITIES ---
        const getMockUser = () => {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('mock_user_id');
        };

        const getAuthQuery = () => {
            const mockUser = getMockUser();
            return mockUser ? `?mock_user_id=${mockUser}` : '';
        };

        const routeByRole = (role) => {
            if (role === 'teacher') {
                window.location.href = '/teach_frontend.html';
            } else if (role === 'stuco_admin') {
                window.location.href = '/stuco_admin_dashboard.html';
            } else {
                window.location.href = '/feedback';
            }
        };

        const escapeHtml = (value) => {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#039;');
        };

        const ensureStudentAccess = async () => {
            const mockUser = getMockUser();
            if (mockUser) {
                userPill.textContent = `Mock user #${mockUser}`;
                logoutBtn.classList.add('hidden');
                return true;
            }
            try {
                const response = await fetch(API_AUTH_ME);
                if (!response.ok) throw new Error('Not signed in');
                const data = await response.json();
                const user = data.user || {};
                if (user.role !== 'student') {
                    routeByRole(user.role);
                    return false;
                }
                userPill.textContent = `${user.name || user.email} (Student)`;
                return true;
            } catch (error) {
                const next = encodeURIComponent('/feedback');
                window.location.href = `/auth.html?next=${next}`;
                return false;
            }
        };

        const showMessage = (message, type) => {
            submissionMessage.textContent = message;
            submissionMessage.classList.remove('hidden', 'alert-success', 'alert-error', 'alert-warning', 'alert-info');
            submissionMessage.classList.add('alert');
            if (type === 'success') {
                submissionMessage.classList.add('alert-success');
            } else if (type === 'error') {
                submissionMessage.classList.add('alert-error');
            } else if (type === 'warning') {
                submissionMessage.classList.add('alert-warning');
            } else {
                submissionMessage.classList.add('alert-info');
            }
            submissionMessage.classList.remove('hidden');
        };

        const updateShareNameToggle = () => {
            shareNameToggleInner.classList.toggle('active', shareName);
            shareNameToggleInner.setAttribute('aria-checked', shareName ? 'true' : 'false');
        };

        const setCollapsible = (element, isOpen) => {
            element.classList.toggle('is-open', isOpen);
        };

        const getContextLabelText = (category) => {
            return categoryMap[category]?.context_label || "Relevant detail (optional)";
        };

        const statusBadge = (status) => {
            if (!status) return 'badge gray';
            if (status === 'Approved') return 'badge green';
            if (status === 'Screened - Escalation') return 'badge red';
            if (status === 'Retracted by Admin') return 'badge gray';
            return 'badge blue';
        };

        const ICON_MAP = {
            'teacher': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 2a4 4 0 0 0-4 4v2a4 4 0 1 0 8 0V6a4 4 0 0 0-4-4Zm-7 18a7 7 0 0 1 14 0H5Z" /></svg>',
            'food': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v4a7 7 0 0 1-7 7H11a7 7 0 0 1-7-7V7Z" /></svg>',
            'policy': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M7 4a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v2h2a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2V4Z" /></svg>',
            'equipment': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M4 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14l-4-2-4 2-4-2-4 2V5Z" /></svg>',
            'school-buses': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M5 3h14a2 2 0 0 1 2 2v11a3 3 0 0 1-3 3h-1a2 2 0 1 1-4 0H11a2 2 0 1 1-4 0H6a3 3 0 0 1-3-3V5a2 2 0 0 1 2-2Z" /></svg>',
            'other': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 2a10 10 0 1 0 10 10A10.02 10.02 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z" /></svg>',
            'help': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M4 4h16a2 2 0 0 1 2 2v8a4 4 0 0 1-4 4H9l-5 4V6a2 2 0 0 1 2-2Z" /></svg>'
        };

        const renderCategories = (categories) => {
            if (!categories.length) {
                categoryGrid.innerHTML = '<div class="category-card">No categories available.</div>';
                primaryCategoryBtn.textContent = 'No categories';
                secondaryCategoryBtn.classList.add('hidden');
                return;
            }

            categoryMap = categories.reduce((acc, item) => {
                acc[item.slug] = item;
                return acc;
            }, {});

            categoryGrid.innerHTML = categories.map((item, index) => {
                const icon = ICON_MAP[item.icon] || ICON_MAP[item.slug] || ICON_MAP.other;
                return `
                    <button data-category="${item.slug}" class="category-card nav-btn" style="animation-delay: ${0.05 + index * 0.05}s;">
                        <div class="category-icon">${icon}</div>
                        <h4>${escapeHtml(item.title)}</h4>
                        <p>${escapeHtml(item.description || '')}</p>
                    </button>
                `;
            }).join('');

            const heroPrimary = categories[0];
            const heroSecondary = categories[1] || categories[0];
            if (heroPrimary) {
                primaryCategoryBtn.dataset.category = heroPrimary.slug;
                primaryCategoryBtn.textContent = heroPrimary.title;
                primaryCategoryBtn.classList.remove('hidden');
            }
            if (heroSecondary) {
                secondaryCategoryBtn.dataset.category = heroSecondary.slug;
                secondaryCategoryBtn.textContent = heroSecondary.title;
                secondaryCategoryBtn.classList.remove('hidden');
            } else {
                secondaryCategoryBtn.classList.add('hidden');
            }
        };

        const loadCategories = async () => {
            try {
                const response = await fetch(API_CATEGORIES);
                if (!response.ok) throw new Error('Unable to load categories');
                const items = await response.json();
                const active = items.filter(item => item.is_active !== false);
                renderCategories(active);
            } catch (error) {
                categoryGrid.innerHTML = '<div class="category-card">Categories are unavailable right now.</div>';
                primaryCategoryBtn.textContent = 'Categories unavailable';
                secondaryCategoryBtn.classList.add('hidden');
            }
        };

        const renderRecentFeedback = (items) => {
            if (!items.length) {
                recentFeedback.innerHTML = '<div class="feed-card">No submissions yet. Your first feedback will show up here.</div>';
                return;
            }
            recentFeedback.innerHTML = items.slice(0, 3).map(item => {
                const label = escapeHtml(categoryMap[item.category]?.title || item.category);
                const teacher = item.teacher_name ? `Teacher: ${escapeHtml(item.teacher_name)}` : 'General feedback';
                const dateText = item.created_at ? new Date(item.created_at).toLocaleDateString() : 'Recent';
                return `
                    <div class="feed-card">
                        <div class="flex items-center justify-between gap-3 flex-wrap">
                            <h4 class="text-lg font-semibold">${label}</h4>
                            <span class="${statusBadge(item.status)}">${escapeHtml(item.status)}</span>
                        </div>
                        <p class="text-sm text-slate-500 mt-2">${teacher} - ${dateText}</p>
                        ${item.context_detail ? `<p class="text-sm text-slate-600 mt-2">Context: ${escapeHtml(item.context_detail)}</p>` : ''}
                    </div>
                `;
            }).join('');
        };

        const loadRecentFeedback = async () => {
            try {
                const response = await fetch(API_STUDENT_FEEDBACK + getAuthQuery());
                if (!response.ok) throw new Error('Unable to load feedback history');
                const items = await response.json();
                renderRecentFeedback(items);
            } catch (error) {
                recentFeedback.innerHTML = '<div class="feed-card">Feedback history is unavailable right now.</div>';
            }
        };

        // --- FORM STAGE CONTROL LOGIC ---
        const goToForm = (category) => {
            const categoryData = categoryMap[category];
            if (!categoryData) {
                return;
            }
            const isTeacher = categoryData?.requires_teacher;
            const isGeneralContext = !isTeacher;

            homeScreen.classList.add('hidden-page');
            formContainer.classList.remove('hidden-page');

            currentCategoryTitle.textContent = categoryData?.title || 'General Submission';
            selectedCategoryInput.value = category;

            setCollapsible(teacherFieldsContainer, isTeacher);
            setCollapsible(teacherRatingsContainer, isTeacher);
            setCollapsible(generalFieldsContainer, !isTeacher && isGeneralContext);

            yearLevelSelect.required = isTeacher;
            teacherSelect.required = isTeacher;

            contextLabel.textContent = getContextLabelText(category);
            feedbackTextLabelNumber.textContent = isTeacher ? '3' : '2';

            if (!isTeacher) {
                yearLevelSelect.value = '';
                teacherSelect.value = '';
                teacherSelect.innerHTML = '<option value="" disabled selected>Select teacher</option>';
                teacherSelect.disabled = true;
                resetStarRatings();
            } else {
                contextField.value = '';
            }
            feedbackText.value = '';

            const mockUser = getMockUser();
            if (mockUser) {
                selectedCategoryInput.dataset.mockUser = mockUser;
            }
            formContainer.scrollTop = 0;
        };

        const goToHome = () => {
            formContainer.classList.add('hidden-page');
            homeScreen.classList.remove('hidden-page');
            submissionMessage.classList.add('hidden');
            form.reset();
            resetStarRatings();
        };

        // --- DYNAMIC FORM FIELD LOGIC ---
        const populateTeachers = async () => {
            const year = yearLevelSelect.value;
            teacherSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
            teacherSelect.disabled = true;
            if (!year) {
                teacherSelect.innerHTML = '<option value="" disabled selected>Select teacher</option>';
                return;
            }
            try {
                const response = await fetch(`${API_TEACHERS_URL}?year_level=${year}`);
                if (!response.ok) throw new Error('Failed to fetch teachers');
                const filtered = await response.json();
                teacherSelect.innerHTML = '<option value="" disabled selected>Select teacher</option>';
                if (filtered.length === 0) {
                    teacherSelect.innerHTML = '<option value="" disabled>No teachers found</option>';
                    return;
                }
                filtered.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    teacherSelect.appendChild(option);
                });
                teacherSelect.disabled = false;
            } catch (error) {
                console.error("Error fetching teachers:", error);
                teacherSelect.innerHTML = '<option value="" disabled>Error loading teachers</option>';
            }
        };

        // --- V2.0 Star Rating Logic ---
        function handleStarClick(e) {
            if (e.target.name && e.target.name.startsWith('rating-')) {
                const category = e.target.name.replace('rating-', '');
                const value = parseInt(e.target.value, 10);

                if (currentRatings[category] === value) {
                    e.target.checked = false;
                    currentRatings[category] = null;
                } else {
                    currentRatings[category] = value;
                }
            }
        }

        function resetStarRatings() {
            starRatingGroups.forEach(group => {
                const radios = group.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => radio.checked = false);
            });
            currentRatings = { clarity: null, pacing: null, resources: null, support: null };
        }

        // --- FORM SUBMISSION HANDLER ---
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            submissionMessage.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const category = selectedCategoryInput.value;
            if (!category || !feedbackText.value) {
                showMessage('Please select a category and enter your feedback.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit feedback';
                return;
            }

            const payload = {
                category: category,
                feedback_text: feedbackText.value,
                willing_to_share_name: shareName
            };

            if (category === 'teacher') {
                if (!yearLevelSelect.value || !teacherSelect.value) {
                    showMessage('Please select a year level and teacher.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit feedback';
                    return;
                }
                payload.teacher_id = parseInt(teacherSelect.value, 10);
                payload.year_level = yearLevelSelect.value;

                if (currentRatings.clarity) payload.rating_clarity = currentRatings.clarity;
                if (currentRatings.pacing) payload.rating_pacing = currentRatings.pacing;
                if (currentRatings.resources) payload.rating_resources = currentRatings.resources;
                if (currentRatings.support) payload.rating_support = currentRatings.support;
            } else {
                payload.year_level = yearLevelSelect.value || 'N/A';
            }

            if (contextField.value.trim()) {
                payload.context_detail = contextField.value.trim();
            }

            let apiUrl = API_SUBMIT_URL + getAuthQuery();

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (response.ok) {
                    let successMessage = `Success! Feedback ID ${result.id} submitted.`;
                    if (result.status === 'Screened - Escalation') {
                        successMessage = `Warning: Your submission (ID: ${result.id}) was flagged by AI. It has been routed to STUCO for review.`;
                        showMessage(successMessage, 'warning');
                    } else {
                        showMessage(successMessage, 'success');
                    }

                    form.reset();
                    shareName = false;
                    updateShareNameToggle();
                    contextField.value = '';
                    resetStarRatings();

                    loadRecentFeedback();
                    setTimeout(goToHome, 2000);
                } else {
                    showMessage(`Submission error: ${result.error || response.statusText}.`, 'error');
                }
            } catch (error) {
                console.error('Network Error during Submission:', error);
                showMessage('Network error: Could not connect to the server.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit feedback';
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const allowed = await ensureStudentAccess();
            if (!allowed) return;

            YEAR_LEVEL_OPTIONS.forEach(yl => {
                const option = document.createElement('option');
                option.value = yl;
                option.textContent = yl;
                yearLevelSelect.appendChild(option);
            });
            document.addEventListener('click', (event) => {
                const button = event.target.closest('.nav-btn');
                if (button && button.dataset.category) {
                    goToForm(button.dataset.category);
                }
            });
            backButton.addEventListener('click', goToHome);
            yearLevelSelect.addEventListener('change', populateTeachers);
            form.addEventListener('submit', handleFormSubmit);
            shareNameToggleInner.addEventListener('click', () => {
                shareName = !shareName;
                updateShareNameToggle();
            });
            teacherRatingsContainer.addEventListener('click', handleStarClick);

            logoutBtn.addEventListener('click', async () => {
                if (getMockUser()) {
                    window.location.href = '/';
                    return;
                }
                await fetch(API_AUTH_LOGOUT, { method: 'POST' });
                window.location.href = '/';
            });

            updateShareNameToggle();
            await loadCategories();
            loadRecentFeedback();
        });
    </script>
</body>
</html>
